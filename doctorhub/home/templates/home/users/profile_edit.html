{% extends 'doctorhub/layouts/rtl/light/green/master.html' %}

{% load staticfiles %}
{% load pages %}

{% block additional_css %}

    <link rel="stylesheet" href="{% static 'doctorhub/more/css/persian-datepicker.min.css' %}"/>

{#    <link rel="stylesheet" href="{% static 'doctorhub/more/css/bootstrap.min.css' %}"/>#}
    <link rel="stylesheet" href="{% static 'doctorhub/more/css/croppie.css' %}" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>

    <link rel="stylesheet" href="{% static 'doctorhub/more/css/croppie-image-field.css' %}">

{% endblock %}

{% block page_title %}

{% endblock %}

{% block breadcrumb %}

    <li class="breadcrumb-item active">
        ويرايش
    </li>

    <li class="breadcrumb-item">
        <a href="">
            حساب كاربرى
        </a>
    </li>

{% endblock %}

{% block main_content %}

    {% load staticfiles %}
    {% load crispy_forms_tags %}
    {% load pages %}

    <div class="row">
        <div class="col-md-1"></div>
        <div class="col-md-10">
            <div class="card border-success">
                <div class="card-header bg-success text-center">
                    <img src="{% static 'doctorhub/assets/images/logo-light-text.png' %}"
                         alt="DigitalTeb" class="dark-logo"/>
                </div>
                <div class="card-body bg-dark" style="padding-left: 10%; padding-right: 10%;">

                    <div class="form-group">
                        <label>
                            تصوير پروفايل
                        </label>
                        <br>
                        <small class="form-text text-muted">
                            براى تغيير عكس روى آن كليك كنيد
                        </small>
                        <div class="container">
                            <div class="row">
                                <div class="col-xs-12 form-group">
                                    <label for="id_profile_image">
                                        {{ profile_form.profile_image.label }}
                                    </label>
                                    <label class="cabinet center-block">
                                        <figure>
                                            <img src="" style="width: 200px; height: 200px;"
                                                 class="gambar img-responsive img-thumbnail"
                                                 id="item-img-output"/>
                                        </figure>
                                        <input id="id_profile_image"
                                               type="file"
                                               class="item-img file center-block"
                                               accept="image/*"
                                               name="profile_image"/>
                                    </label>

                                </div>
                            </div>
                        </div>
                        <div class="modal fade" id="cropImagePop" tabindex="-1" role="dialog"
                             aria-labelledby="myModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal"
                                                aria-label="Close"><span aria-hidden="true">&times;</span>
                                        </button>
                                        <h4 class="modal-title" id="myModalLabel">
                                            <?=multiLanguage( "Edit Foto" , "Edit Photo" )?></h4>
                                    </div>
                                    <div class="modal-body">
                                        <div id="upload-demo" class="center-block"></div>
                                    </div>
                                    <div class="modal-footer" dir="ltr">
                                        <button type="button" class="btn btn-outline-dark" data-dismiss="modal">
                                            Close
                                        </button>
                                        <button type="button" id="cropImageBtn" class="btn btn-success">Crop
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <form id="profile-edit-form"
                          action="{% url 'edit_account' %}"
                          enctype="multipart/form-data"
                          onsubmit="onSubmitFunction()"
                          method="POST">
                        {% csrf_token %}
                        <div class="form-row">
                            <div class="form-group col-md-4 mb-0">
                                {{ user_form.username|as_crispy_field }}
                            </div>
                            <div class="form-group col-md-4 mb-0">
                                {{ user_form.first_name|as_crispy_field }}
                            </div>
                            <div class="form-group col-md-4 mb-0">
                                {{ user_form.last_name|as_crispy_field }}
                            </div>

                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-4 mb-0">
                                {{ profile_form.gender|as_crispy_field }}
                            </div>
                            <div class="form-group col-md-4 mb-0">
                            {{ phone_form.number|as_crispy_field }}
                            </div>
                            <div class="form-group col-md-4 mb-0">
                                {{ profile_form.birthdate|as_crispy_field }}
                                <input type="hidden" id="birthdate-input">
                            </div>
                        </div>
                        <br>
                        <br>
                        <div class="form-row">
                            <div class="col-md-2"></div>
                            <div class="col-md-4 mt-3">
                                <button type="submit"
                                        style="width: 100%; height: 100%;"
                                        class="btn btn-success btn-lg">
                                    ثبت تغييرات
                                </button>
                            </div>
                            <div class="col-md-4 mt-3">
                                <a style="width: 100%; height: 100%;"
                                   href="{% url 'change_password' %}"
                                   class="btn btn-outline-success btn-lg">
                                    تغيير رمز عبور
                                </a>
                            </div>
                            <div class="col-md-2"></div>
                        </div>
                        <br>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-1"></div>
    </div>

{% endblock %}

{% block additional_js %}

    <script src="{% static 'doctorhub/more/js/persian-date.min.js' %}"></script>
    <script src="{% static 'doctorhub/more/js/persian-datepicker.min.js' %}"></script>
    <script src="{% static 'doctorhub/more/js/croppie.min.js' %}"></script>

    <script>

        // Start upload preview image
        $(".gambar").attr("src", "{{ request.user.profile.image_url }}");
        var $uploadCrop,
            tempFilename,
            rawImg,
            imageId;

        function readFile(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('.upload-demo').addClass('ready');
                    $('#cropImagePop').modal('show');
                    rawImg = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            } else {
                swal("Sorry - you're browser doesn't support the FileReader API");
            }
        }

        $uploadCrop = $('#upload-demo').croppie({
            showZoomer: false,
            viewport: {
                width: 200,
                height: 200,
                type: 'circle'
            },
            enforceBoundary: false,
            enableExif: true
        });
        $('#cropImagePop').on('shown.bs.modal', function () {
            // alert('Shown pop');
            $uploadCrop.croppie('bind', {
                url: rawImg
            }).then(function () {
                console.log('jQuery bind complete');
            });
        });

        $('.item-img').on('change', function () {
            imageId = $(this).data('id');
            tempFilename = $(this).val();
            $('#cancelCropBtn').data('id', imageId);
            readFile(this);
        });
        $('#cropImageBtn').on('click', function (ev) {
            $uploadCrop.croppie('result', {
                type: 'base64',
                format: 'jpeg',
                size: {width: 200, height: 200}
            }).then(function (resp) {
                $('#item-img-output').attr('src', resp);
                $('#cropImagePop').modal('hide');
            });
        });
        // End upload preview image

    </script>

    <script>
        function post_form() {
            set_gregorian_date();
            var fd = set_image();
            $.ajax({
                url: "{% url 'edit_account' %}",
                data: fd,
                processData: false,
                contentType: false,
                type: 'POST',
                success: function (data) {
                },
            });
            return false;
        }
    </script>

    <script>

        function setPersianDatePicker() {
            $(".persian-datepicker").persianDatepicker(
                {
                    formatter: function (unixDate) {
                        var gregorianDate = new Date(unixDate);
                        var day = gregorianDate.getDate().toString();
                        var month = (gregorianDate.getMonth() + 1).toString();
                        var year = gregorianDate.getFullYear().toString();
                        $('#birthdate-input').val(
                            year + '-' + month + '-' + day
                        );
                        var pdate = new persianDate(unixDate);
                        day = pdate.date().toString();
                        month = pdate.month().toString();
                        year = pdate.year().toString();
                        return year + '/' + month + '/' + day
                    },
                    autoClose: true,
                    {#initialValue: false,#}
                }
            );
        }

        function set_gregorian_date() {
            $(".persian-datepicker").val(
                $('#birthdate-input').val()
            );
        }

        $(document).ready(
            setPersianDatePicker()
        );

    </script>

    <script>
        function onSubmitFunction() {
            set_gregorian_date();
            var token = '{{ csrf_token }}';
            var img_data = $('#item-img-output').attr('src');
            $.ajax(
                {
                    type: "POST",
                    headers: { "X-CSRFToken": token },
                    url: "{% url 'update_profile_image' %}",
                    data: {
                        'profile_image': img_data
                    },
                    async: false,
                }
            )
        }
    </script>

{% endblock %}